<!DOCTYPE html>
<html lang = "en">
<head>
    <meta charset="UTF-8">
    <title>HELLO THERE</title>
    <meta name = "author" content = "wheelieGood">
    <link href="{{ url_for('static', filename ='styles.css') }}" rel = "stylesheet" type = "text/css">
</head>


<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
{#<script type="text/javascript" src="{{  url_for('static', filename='app.js') }}"><</script>#}

<div class="nav_bar">
        <header>
            <h1>Wheelie Good - Dublin Bikes</h1>
		      <nav>
			     <ul>
				    <li class="current"><a href="/">Home</a></li>
				    <li ><a href="">Plan your Journey</a></li>
				    <li><a href="about.html">About Us</a></li>
				    <li><a href="contact.html">Contact Us</a></li>
			     </ul>
		      </nav>
            </header>
        </div>



<div id = "city"></div>
<div id = "temp"></div>
<div id = "weather_description"></div>
<div id = "weather_icon"><img id="wicon" src="" alt="Weather icon"></div>


<div id = "map">map</div>
<div id = "bikeTable">bikeTable</div>


<script>

    let map;

    function initMap() {
        fetch("/bikes").then(response=> {
            return response.json();
        }).then(data => {
            console.log("data:", data)

            map = new google.maps.Map(document.getElementById("map"), {
                center: {lat: 53.349804, lng: -6.260310},
                zoom:12,
            });

//          Addition of google markers
            data.forEach(bikes => {
                const marker = new google.maps.Marker({
                    position: { lat: bikes.pos_lat, lng: bikes.pos_lng},
                    map: map,
                });
                marker.addListener("click", () => {
                    const infowindow = new google.maps.InfoWindow({
                        content: bikes.name
                    });
                    infowindow.open(map, marker);
                    bikeData(bikes.name, bikes.number);
                });
            });
        }).catch(err => {
            console.log("OOPS!", err);
        })
    }

    function bikeData(stationName, stationNumber) {

        fetch("/currentBikes").then(response => {
            return response.json();
        }).then(currentData => {
            console.log("currentData:", currentData)
            for (let key in currentData) {
                let standNumber = currentData[key].number;
                if (standNumber == stationNumber) {
                    console.log("stand number is" + standNumber + "station number is " + stationNumber);

                    let tableOut = "<table>";
                    tableOut += "<thead>" + "<tr>" +
                        "<th>Number</th>" +
                        "<th>Name</th>" +
                        "<th>Available Bike Stands</th>" +
                        "<th>Available Bikes</th></tr>" +
                        "</thead>";

                    let number = currentData[key].number;
                    let availableBikes = currentData[key].available_bikes;
                    let availableBikeStands = currentData[key].available_bike_stands;


                    tableOut += "<tr><td>" +
                    number + "</td></tr>" + "<tr><td>" +
                    stationName + "</td></tr>" + "<tr><td>" +
                    availableBikeStands + "</td></tr>" + "<tr><td>" +
                    availableBikes + "</td></tr>";
                    tableOut += "</table>";

                    document.getElementById("bikeTable").innerHTML = tableOut;
                }
            }
        })
    }


//display weather info
    function displayWeather() {
        fetch("/weather").then(response => {
            return response.json();
        }).then(data => {
            console.log("data:", data)
            const last_item = data.length - 1;
            const weather_main = data[last_item].weather_main;
            const weather_icon = data[last_item].weather_icon;
            const weather_city = data[last_item].city_name;
            const weather_temp = data[last_item].main_temp - 273.53;
            var weather_temp_int = parseInt(weather_temp);
            var iconurl = "http://openweathermap.org/img/w/" + weather_icon + ".png";
            document.getElementById('city').innerHTML = weather_city;
            document.getElementById('temp').innerHTML = weather_temp_int+ 'â„ƒ';
            document.getElementById('weather_description').innerHTML = weather_main;
            $('#wicon').attr('src', iconurl);

        });
    }
    displayWeather();

</script>

<script src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyC99AyuHEKOKE1VeDkJuM5MKF-RdTIXEAU&callback=initMap" async></script>


</body>
</html>



